<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details Manager</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <script src="https://api.bitrix24.com/api/v1/"></script>
</head>

<body>
    <div class="container">
        <h1 class="my-4">Product Details Manager</h1>

        <div id="deal-info" class="mb-4 hidden">
            <h3>Deal ID: <span id="deal-id-display">Not set</span></h3>
            <div id="duplicate-warning" class="duplicate-warning"></div>
        </div>

        <div id="products-container">
            <p class="loading-message">Loading application...</p>
        </div>

        <div class="mt-4 hidden" id="save-section">
            <button id="save-btn" class="btn btn-success">Save Changes</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const BITRIX_CONFIG = {
            CLIENT_ID: "local.6821fc71c5ee12.45766183",
            CLIENT_SECRET: "8IsApBGiFBRXz7kkCm9ehEukod7H0WEF1SjEI0ckOK7iSVyKOt",
            REDIRECT_URI: window.location.origin + window.location.pathname,
            AUTH_URL: "https://ideal-solution.bitrix24.com/oauth/authorize/",
            TOKEN_URL: "https://ideal-solution.bitrix24.com/oauth/token/",
            API_URL: "https://ideal-solution.bitrix24.com/rest/"
        };

        const ALLOWED_USER_IDS = new Set(["2924", "8", "18", "1750", "36", "2688", "2690", "2716", "3108", "3114"]);

        let accessToken = localStorage.getItem('bitrix_access_token') || null;
        let refreshToken = localStorage.getItem('bitrix_refresh_token') || null;
        let userId = localStorage.getItem('bitrix_user_id') || null;
        let domain = localStorage.getItem('bitrix_domain') || null;
        let dealId = localStorage.getItem('current_deal_id') || null;
        let productRows = [];

        const dealInfo = document.getElementById('deal-info');
        const dealIdDisplay = document.getElementById('deal-id-display');
        const duplicateWarning = document.getElementById('duplicate-warning');
        const productsContainer = document.getElementById('products-container');
        const saveSection = document.getElementById('save-section');
        const saveBtn = document.getElementById('save-btn');

        window.onload = function () {
            if (typeof BX24 !== 'undefined' && typeof BX24.init === 'function') {
                BX24.init(() => {
                    console.log("BX24 initialized successfully.");
                    initializeInBitrix();
                });
            } else {
                alert("Error: Bitrix24 SDK not loaded.");
            }
        };

        saveBtn.addEventListener('click', handleSave);

        function initializeInBitrix() {
            const authData = BX24.getAuth();
            if (!authData || !authData.access_token) {
                alert("Authentication data is missing. Please authorize the app.");
                BX24.auth(function () {
                    // After authorization, re-initialize
                    console.log("Re-authorized successfully.");
                    initializeInBitrix(); // Retry initialization
                });
                return;
            }

            // If authenticated, proceed with your app logic
            accessToken = authData.access_token;
            userId = authData.user_id;
            domain = window.location.hostname;

            // Proceed with further app setup
            console.log("Authenticated successfully", authData);
        }

        function updateUI() {
            dealInfo.classList.remove('hidden');
            saveSection.classList.remove('hidden');
            dealIdDisplay.textContent = dealId || 'Not set';
        }

        async function fetchDealProducts() {
            try {
                productsContainer.innerHTML = '<p class="loading-message">Loading products...</p>';

                const response = await fetch(`https://${domain}/rest/crm.deal.productrows.get.json?ID=${dealId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    productRows = result.result || [];  // Assuming the response has a `result` field with products
                    renderProducts(productRows);
                } else {
                    throw new Error(`Failed to load products. Status: ${response.status}`);
                }
            } catch (error) {
                showError("Failed to load products.");
                console.error(error);
            }
        }

        function renderProducts(products) {
            const productMap = {};
            const duplicates = [];
            productsContainer.innerHTML = '';

            products.forEach((product, index) => {
                const name = product.PRODUCT_NAME || `Product ${index + 1}`;
                if (productMap[name]) duplicates.push(name);
                productMap[name] = true;

                const row = document.createElement('div');
                row.className = 'product-row';
                row.innerHTML = `
                    <div><strong>${name}</strong></div>
                    <div>Cost: <input type="number" value="${product.PRICE}" class="form-control price-input" data-index="${index}"></div>
                `;
                productsContainer.appendChild(row);
            });

            if (duplicates.length > 0) {
                duplicateWarning.textContent = `Duplicate products found: ${duplicates.join(', ')}`;
            } else {
                duplicateWarning.textContent = '';
            }
        }

        async function handleSave() {
            const inputs = document.querySelectorAll('.price-input');
            inputs.forEach(input => {
                const index = input.dataset.index;
                const value = parseFloat(input.value);
                if (!isNaN(value)) productRows[index].PRICE = value;
            });

            try {
                const response = await fetch(`https://${domain}/rest/crm.deal.productrows.set.json`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({ id: dealId, fields: productRows })
                });

                if (response.ok) {
                    alert('Products updated successfully!');
                } else {
                    throw new Error('Failed to save product changes.');
                }
            } catch (error) {
                showError('Failed to save product changes.');
                console.error(error);
            }
        }

        function showError(message) {
            productsContainer.innerHTML = `<div class="alert alert-danger">${message}</div>`;
        }

        function showMessage(message) {
            productsContainer.innerHTML = `<div class="alert alert-info">${message}</div>`;
        }

        function logout() {
            localStorage.clear();
            window.location.reload();
        }
    </script>
</body>

</html>
